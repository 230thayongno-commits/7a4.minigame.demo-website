<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>7A4 GENIUS â€” GALAXY MISSION</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --to1:#00d2ff; /* Cyan Neon */
      --to2:#ff007f; /* Pink Neon */
      --to3:#a200ff; /* Purple Neon */
      --to4:#39ff14; /* Green Neon */
      --dark:#020617;
      --deep:#0f172a;
      --white:#fff;
      --gray:#94a3b8;
      --glass: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.12);
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;
      font-family:'Nunito',sans-serif;
      color:var(--white);
      min-height:100vh;
      overflow-x:hidden;
      background-color: var(--dark);
      background-image:
        radial-gradient(white, rgba(255,255,255,.2) 1px, transparent 20px),
        radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 40px),
        linear-gradient(to bottom, #020617, #1e1b4b);
      background-size: 200px 200px, 300px 300px, 100% 100%;
    }

    /* toast */
    #toast{
      position:fixed; top:110px; left:50%; transform:translateX(-50%);
      padding:14px 26px;
      background:white; color:black;
      border-radius:999px;
      font-weight:900;
      display:none;
      z-index:99999;
      box-shadow:0 0 30px rgba(255,255,255,.5);
    }

    /* selector screen */
    #selector-screen{
      position:fixed; inset:0;
      z-index:9999;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
      text-align:center;
      background:
        radial-gradient(circle at center, rgba(30,27,75,0.8), var(--dark)),
        url('https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=1200&auto=format&fit=crop');
      background-size:cover;
      background-position:center;
    }

    .selector-box{
      width:100%;
      max-width:520px;
      padding:42px 30px;
      border-radius:40px;
      border:1px solid rgba(255,255,255,0.1);
      background: rgba(15,23,42,0.72);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow:0 0 40px rgba(162,0,255,.35);
    }

    .grid-teams{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:18px;
      margin-top:26px;
    }

    .team-card{
      padding:28px 10px;
      border:none;
      border-radius:24px;
      color:white;
      font-size:1.25em;
      font-weight:900;
      cursor:pointer;
      transition: all .28s cubic-bezier(.175,.885,.32,1.275);
      box-shadow:0 0 15px rgba(255,255,255,0.12);
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .team-card:hover{ transform:scale(1.07); filter:brightness(1.2); box-shadow:0 0 25px currentColor; }
    .team-card:active{ transform:scale(.95); }

    /* main app */
    #main-app{ display:none; }

    header{
      position:sticky; top:0; z-index:100;
      padding:14px 18px;
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(2,6,23,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .logo-text{
      font-weight:900;
      font-size:1.5em;
      text-shadow:0 0 15px var(--to3);
    }
    .status-pill{
      padding:8px 14px;
      border-radius:999px;
      font-weight:900;
      box-shadow:0 0 10px rgba(255,255,255,0.2);
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
    }
    .btn-action-small{
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.18);
      color:var(--white);
      padding:8px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      font-size:.85em;
      transition:.2s;
    }
    .btn-action-small:hover{ background: rgba(255,255,255,0.18); }

    .container{ max-width:920px; margin:0 auto; padding:20px; }

    .rankings{
      background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.1);
      padding:24px;
      border-radius:35px;
      margin-bottom:26px;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    .bar-container{ margin-bottom:16px; }
    .bar-info{
      display:flex; justify-content:space-between;
      margin-bottom:6px;
      font-weight:900;
      font-size:.95em;
      color:#e2e8f0;
    }
    .bar-bg{
      background: rgba(255,255,255,0.05);
      height:16px;
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
    }
    .bar-fill{
      height:100%;
      width:0%;
      transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:18px;
    }

    .card{
      grid-column: span 12;
      background: rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:35px;
      padding:26px;
      text-align:center;
      position:relative;
      overflow:hidden;
      transition: transform .25s;
    }
    .card:hover{ transform: translateY(-4px); background: rgba(255,255,255,0.08); }

    @media(min-width: 860px){
      .card.half{ grid-column: span 6; }
    }

    .subject-icon{
      font-size:3.2em;
      margin-bottom:12px;
      display:block;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
    }

    .badge-soon{
      position:absolute; top:14px; right:-42px;
      background: var(--gray);
      color:white;
      padding:6px 50px;
      transform: rotate(45deg);
      font-size:.75em;
      font-weight:900;
      opacity:.9;
    }
    .upcoming{
      opacity:.65;
      border:1px dashed rgba(255,255,255,0.22);
    }

    .btn-start{
      background: linear-gradient(45deg, var(--to3), var(--to1));
      color:white;
      border:none;
      padding:14px 42px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      font-size:1.05em;
      box-shadow:0 5px 20px rgba(162,0,255,0.4);
      transition:.25s;
    }
    .btn-start:hover{ transform:scale(1.05); box-shadow:0 8px 25px rgba(162,0,255,0.6); }

    .btn-ghost{
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.18);
      color:white;
      padding:12px 18px;
      border-radius:16px;
      font-weight:900;
      cursor:pointer;
      transition:.2s;
    }
    .btn-ghost:hover{ background: rgba(255,255,255,0.16); }

    .game-area{
      background: rgba(0,0,0,0.38);
      border-radius:24px;
      padding:18px;
      margin-top:16px;
      border:1px solid rgba(255,255,255,0.1);
      text-align:left;
    }

    input, textarea{
      width:100%;
      padding:14px 16px;
      border:2px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:white;
      border-radius:18px;
      font-size:1.05em;
      outline:none;
      transition:.25s;
    }
    input:focus, textarea:focus{
      border-color: var(--to1);
      box-shadow: 0 0 20px rgba(0,210,255,0.25);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:160px; }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
      font-weight:900;
      font-size:.92em;
    }

    .muted{ color: var(--gray); font-weight:800; }
    .big-title{ font-size:1.25em; font-weight:900; margin:0 0 8px 0; }
    .hr{ height:1px; background: rgba(255,255,255,0.1); margin:14px 0; }

    .link-btn{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:14px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      text-decoration:none;
      color:white;
      font-weight:900;
      transition:.2s;
    }
    .link-btn:hover{ transform: translateY(-2px); background: rgba(255,255,255,0.10); }

    .chip{
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      font-size:.85em;
      white-space:nowrap;
    }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.92em;
      line-height:1.4;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      min-height:120px;
      white-space:pre-wrap;
    }

    .pill-danger{ background: rgba(255,0,127,0.12); border:1px solid rgba(255,0,127,0.35); }
    .pill-ok{ background: rgba(57,255,20,0.12); border:1px solid rgba(57,255,20,0.35); }
    .pill-info{ background: rgba(0,210,255,0.12); border:1px solid rgba(0,210,255,0.35); }
  </style>
</head>

<body>
  <div id="toast"></div>

  <!-- MÃ€N HÃŒNH CHá»ŒN Tá»” -->
  <div id="selector-screen">
    <div class="selector-box">
      <h1 style="margin:0 0 6px 0;font-size:3.3em;font-weight:900;">7A4</h1>
      <p style="margin:0;color:var(--to1);font-weight:900;letter-spacing:4px;font-size:.82em;">
        GALAXY MISSION CONTROL
      </p>

      <p style="color:#cbd5e1;font-weight:900;margin-top:26px;margin-bottom:0;">
        XÃC NHáº¬N PHI Äá»˜I
      </p>

      <div class="grid-teams">
        <button type="button" class="team-card" onclick="initTeam('Tá»• 1')" style="background:var(--to1); box-shadow:0 0 20px rgba(0,210,255,0.3)">Tá»” 1</button>
        <button type="button" class="team-card" onclick="initTeam('Tá»• 2')" style="background:var(--to2); box-shadow:0 0 20px rgba(255,0,127,0.3)">Tá»” 2</button>
        <button type="button" class="team-card" onclick="initTeam('Tá»• 3')" style="background:var(--to3); box-shadow:0 0 20px rgba(162,0,255,0.3)">Tá»” 3</button>
        <button type="button" class="team-card" onclick="initTeam('Tá»• 4')" style="background:var(--to4); box-shadow:0 0 20px rgba(57,255,20,0.3); color:#04120a">Tá»” 4</button>
      </div>

      <p class="muted" style="margin-top:18px;font-weight:900;">
        âš¡ Äiá»ƒm sáº½ tá»± reset má»—i tuáº§n (tá»± Ä‘á»™ng)
      </p>
    </div>
  </div>

  <!-- APP CHÃNH -->
  <div id="main-app">
    <header>
      <div class="logo-text">7A4 GENIUS HUB</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span id="team-tag" class="status-pill"></span>
        <button class="btn-action-small" onclick="switchTeam()">Äá»•i Tá»•</button>
      </div>
    </header>

    <div class="container">
      <!-- Báº¢NG Xáº¾P Háº NG -->
      <div class="rankings">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div style="flex:2; min-width:240px;">
            <h3 style="margin:0; letter-spacing:1px;">ğŸ›¸ Báº¢NG Xáº¾P Háº NG PHI HÃ€NH ÄOÃ€N</h3>
            <div class="muted" style="margin-top:6px;">
              Má»—i tuáº§n sáº½ reset Ä‘iá»ƒm 1 láº§n (tá»± Ä‘á»™ng).
            </div>
          </div>
          <div style="flex:1; min-width:220px;">
            <div class="tag pill-info" id="week-tag">ğŸ“… Tuáº§n: ...</div>
          </div>
        </div>

        <div id="rank-bars" style="margin-top:20px;"></div>
      </div>

      <div class="grid">
        <!-- TIKTOK -->
        <div class="card half">
          <span class="subject-icon">ğŸ“±</span>
          <h3 style="margin:0 0 6px 0;">KÃªnh TikTok 7A4</h3>
          <p class="muted" style="margin:0 0 16px 0;">Follow Ä‘á»ƒ update drama + highlight ğŸ˜‚</p>

          <a class="link-btn" href="https://www.tiktok.com/@a4.tvl.2025.2026" target="_blank" rel="noopener">
            <span>ğŸš€ @a4.tvl.2025.2026</span>
            <span class="chip">Má»Ÿ</span>
          </a>

          <div style="height:10px"></div>

          <a class="link-btn" href="https://www.tiktok.com/@7a4.tvl.2025.2026" target="_blank" rel="noopener">
            <span>ğŸŒŒ @7a4.tvl.2025.2026</span>
            <span class="chip">Má»Ÿ</span>
          </a>
        </div>

        <!-- TOÃN -->
        <div class="card half">
          <span class="subject-icon">ğŸ“</span>
          <h3 style="margin:0 0 6px 0;">ToÃ¡n Pháº£n Xáº¡</h3>
          <p class="muted" style="margin:0 0 14px 0;">Tráº£ lá»i Ä‘Ãºng +5 Ä‘iá»ƒm cho tá»• báº¡n</p>

          <div id="math-start-ui">
            <button class="btn-start" onclick="startMath()">Khai hoáº£</button>
          </div>

          <div id="math-game-ui" class="game-area" style="display:none;">
            <div class="tag pill-info" style="margin-bottom:10px;">ğŸ“Œ CÃ¢u há»i</div>
            <div id="math-q" style="font-size:1.6em;font-weight:900;margin-bottom:12px;"></div>

            <div class="row">
              <input type="number" id="math-input" inputmode="numeric" placeholder="Nháº­p Ä‘Ã¡p Ã¡n..." />
              <button class="btn-ghost" onclick="submitMath()">Tráº£ lá»i</button>
            </div>

            <div class="hr"></div>
            <button class="btn-action-small" onclick="stopMath()">ThoÃ¡t</button>
          </div>
        </div>

        <!-- VUA Ná»I Tá»ª -->
        <div class="card">
          <span class="subject-icon">ğŸ‘‘</span>
          <h3 style="margin:0 0 6px 0;">VUA Ná»I Tá»ª â€” Galaxy Arena</h3>
          <p class="muted" style="margin:0 0 16px 0;">
            Luáº­t nhÆ° noitu.pro/solo: tá»« sau pháº£i báº¯t Ä‘áº§u báº±ng chá»¯ cuá»‘i cá»§a tá»« trÆ°á»›c.
            VÃ­ dá»¥: <b>Ä‘á»“ Äƒn</b> â†’ pháº£i ná»‘i báº±ng tá»« báº¯t Ä‘áº§u chá»¯ <b>Äƒn</b>.
          </p>

          <div class="row" style="margin-bottom:10px;">
            <button class="btn-start" onclick="openWordMode('ai')">ğŸ¤– Solo vá»›i Robot AI</button>
            <button class="btn-ghost" onclick="openWordMode('online')">ğŸŒ Online 1vs1 (P2P)</button>
          </div>

          <div id="word-ui" class="game-area" style="display:none;">
            <div class="row" style="align-items:center;">
              <div class="tag pill-info" id="word-mode-tag">Cháº¿ Ä‘á»™: ...</div>
              <div class="tag" id="word-rule-tag">Luáº­t: ...</div>
              <button class="btn-action-small" onclick="closeWord()">ÄÃ³ng</button>
            </div>

            <div class="hr"></div>

            <div class="row" style="margin-bottom:10px;">
              <div class="tag" id="word-last">Tá»« hiá»‡n táº¡i: (chÆ°a cÃ³)</div>
              <div class="tag pill-ok" id="word-score">+0 Ä‘iá»ƒm</div>
            </div>

            <div class="row">
              <input id="word-input" placeholder="Nháº­p tá»« Ä‘á»ƒ ná»‘i..." autocomplete="off" />
              <button class="btn-ghost" onclick="submitWord()">Gá»­i</button>
            </div>

            <div class="hr"></div>

            <div class="row" style="margin-bottom:10px;">
              <button class="btn-ghost" onclick="wordHint()">ğŸ’¡ Gá»£i Ã½</button>
              <button class="btn-ghost" onclick="wordGiveUp()">ğŸ³ï¸ Xin thua</button>
              <button class="btn-ghost" onclick="wordRestart()">ğŸ”„ ChÆ¡i láº¡i</button>
            </div>

            <!-- ONLINE -->
            <div id="online-ui" style="display:none;">
              <div class="hr"></div>
              <div class="tag pill-info">ğŸŒ Online 1vs1 (P2P)</div>
              <p class="muted" style="margin:10px 0 0 0;">
                VÃ¬ báº¡n upload HTML lÃªn web tÄ©nh, mÃ¬nh lÃ m online kiá»ƒu â€œphÃ²ng báº±ng linkâ€ dÃ¹ng WebRTC.
                Báº¡n táº¡o phÃ²ng â†’ gá»­i link cho báº¡n khÃ¡c má»Ÿ lÃ  chÆ¡i Ä‘Æ°á»£c.
              </p>
              <div class="row" style="margin-top:10px;">
                <button class="btn-start" onclick="onlineCreateRoom()">Táº¡o phÃ²ng</button>
                <button class="btn-ghost" onclick="onlineJoinRoom()">VÃ o phÃ²ng</button>
              </div>

              <div class="hr"></div>
              <div class="muted">MÃ£ phÃ²ng / link:</div>
              <textarea id="online-room" rows="3" placeholder="Sáº½ hiá»‡n link á»Ÿ Ä‘Ã¢y..."></textarea>
            </div>

            <div class="hr"></div>
            <div class="tag">ğŸ“œ Lá»‹ch sá»­</div>
            <div id="word-log" class="log"></div>
          </div>
        </div>

        <!-- Sáº®P CÃ“ -->
        <div class="card half upcoming">
          <div class="badge-soon">Sáº®P CÃ“</div>
          <span class="subject-icon">ğŸ§©</span>
          <h3 style="margin:0 0 6px 0;">Äá»‘ vui thÃ nh viÃªn trong lá»›p</h3>
          <p class="muted" style="margin:0;">
            Ai lÃ  ngÆ°á»i... (siÃªu láº§y / siÃªu chÄƒm / hay ngá»§ gáº­t) ğŸ˜­
          </p>
        </div>

        <div class="card half upcoming">
          <div class="badge-soon">Sáº®P CÃ“</div>
          <span class="subject-icon">ğŸ‡¬ğŸ‡§</span>
          <h3 style="margin:0 0 6px 0;">Tiáº¿ng Anh</h3>
          <p class="muted" style="margin:0;">
            Mini quiz tá»« vá»±ng + phÃ¡t Ã¢m + cÃ¢u há»i nhanh
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   UTIL
========================= */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>t.style.display="none", 1800);
}

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

function normalizeWord(s){
  return (s||"")
    .toLowerCase()
    .trim()
    .replace(/\s+/g,' ')
    .replace(/[.,!?;:()"']/g,'');
}

function getLastChar(word){
  word = normalizeWord(word);
  if(!word) return "";
  // láº¥y kÃ½ tá»± cuá»‘i cÃ¹ng (bá» khoáº£ng tráº¯ng)
  return word[word.length-1];
}

function getFirstChar(word){
  word = normalizeWord(word);
  if(!word) return "";
  return word[0];
}

/* =========================
   WEEKLY RESET SCORE
========================= */
const STORAGE_KEY = "7a4_galaxy_scores_v1";
const DEFAULT_SCORES = { "Tá»• 1":0, "Tá»• 2":0, "Tá»• 3":0, "Tá»• 4":0 };

function getWeekId(){
  // tuáº§n ISO Ä‘Æ¡n giáº£n (theo thá»© 2)
  const d = new Date();
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  return `${date.getUTCFullYear()}-W${weekNo}`;
}

function loadScores(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    return { week: getWeekId(), scores: {...DEFAULT_SCORES} };
  }
  try{
    const obj = JSON.parse(raw);
    if(!obj.week || !obj.scores) throw 0;
    return obj;
  }catch(e){
    return { week: getWeekId(), scores: {...DEFAULT_SCORES} };
  }
}

function saveScores(data){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function weeklyResetIfNeeded(){
  let data = loadScores();
  const currentWeek = getWeekId();
  if(data.week !== currentWeek){
    data.week = currentWeek;
    data.scores = {...DEFAULT_SCORES};
    saveScores(data);
    toast("ğŸ“… Sang tuáº§n má»›i! Äiá»ƒm Ä‘Ã£ reset âœ¨");
  }
  document.getElementById("week-tag").textContent = "ğŸ“… Tuáº§n: " + data.week;
  return data;
}

function addScore(team, amount){
  const data = weeklyResetIfNeeded();
  data.scores[team] = (data.scores[team]||0) + amount;
  saveScores(data);
  renderRanking();
}

function renderRanking(){
  const data = weeklyResetIfNeeded();
  const scores = data.scores;

  const max = Math.max(1, ...Object.values(scores));
  const colors = {
    "Tá»• 1":"var(--to1)",
    "Tá»• 2":"var(--to2)",
    "Tá»• 3":"var(--to3)",
    "Tá»• 4":"var(--to4)",
  };

  const wrap = document.getElementById("rank-bars");
  wrap.innerHTML = "";

  Object.keys(scores).forEach(team=>{
    const val = scores[team];
    const pct = clamp((val/max)*100, 0, 100);

    const div = document.createElement("div");
    div.className = "bar-container";
    div.innerHTML = `
      <div class="bar-info">
        <span>${team}</span>
        <span>${val} Ä‘iá»ƒm</span>
      </div>
      <div class="bar-bg">
        <div class="bar-fill" style="background:${colors[team]}; width:${pct}%"></div>
      </div>
    `;
    wrap.appendChild(div);
  });
}

/* =========================
   TEAM SELECTOR
========================= */
let currentTeam = null;

function initTeam(teamName){
  currentTeam = teamName;
  localStorage.setItem("team", teamName);

  const tag = document.getElementById("team-tag");
  tag.textContent = teamName;

  // mÃ u theo tá»•
  const colorMap = {"Tá»• 1":"var(--to1)","Tá»• 2":"var(--to2)","Tá»• 3":"var(--to3)","Tá»• 4":"var(--to4)"};
  tag.style.background = "rgba(255,255,255,0.08)";
  tag.style.borderColor = "rgba(255,255,255,0.18)";
  tag.style.boxShadow = "0 0 18px rgba(255,255,255,0.18)";
  tag.style.color = "#fff";
  tag.style.textShadow = `0 0 18px ${colorMap[teamName]}`;

  document.getElementById("selector-screen").style.display = "none";
  document.getElementById("main-app").style.display = "block";

  weeklyResetIfNeeded();
  renderRanking();
  toast("ğŸš€ ÄÃ£ vÃ o cÄƒn cá»©: " + teamName);
}

function switchTeam(){
  localStorage.removeItem("team");
  currentTeam = null;
  document.getElementById("main-app").style.display = "none";
  document.getElementById("selector-screen").style.display = "flex";
}

/* =========================
   MATH GAME
========================= */
let mathA=0, mathB=0;
function startMath(){
  document.getElementById("math-start-ui").style.display = "none";
  document.getElementById("math-game-ui").style.display = "block";
  nextMath();
}
function stopMath(){
  document.getElementById("math-start-ui").style.display = "block";
  document.getElementById("math-game-ui").style.display = "none";
}
function nextMath(){
  mathA = Math.floor(Math.random()*50)+1;
  mathB = Math.floor(Math.random()*50)+1;
  document.getElementById("math-q").textContent = `${mathA} + ${mathB} = ?`;
  const inp = document.getElementById("math-input");
  inp.value = "";
  inp.focus();
}
function submitMath(){
  if(!currentTeam){ toast("Báº¡n chÆ°a chá»n tá»•!"); return; }
  const ans = Number(document.getElementById("math-input").value);
  if(ans === mathA + mathB){
    toast("âœ… ChÃ­nh xÃ¡c! +5 Ä‘iá»ƒm");
    addScore(currentTeam, 5);
    nextMath();
  }else{
    toast("âŒ Sai rá»“i!");
  }
}

/* =========================
   WORD CHAIN (NOI TU) - AI + ONLINE
========================= */
let wordMode = null; // "ai" | "online"
let wordLast = "";   // tá»« hiá»‡n táº¡i
let wordUsed = new Set();
let wordPoints = 0;
let wordLog = [];

const BOT_DELAY = 650;

/**
 * Bá»™ tá»« vá»±ng mini offline Ä‘á»ƒ bot dÃ¹ng + kiá»ƒm tra nhanh.
 * (KhÃ´ng thá»ƒ cÃ³ "tá»« Ä‘iá»ƒn tiáº¿ng Viá»‡t chuáº©n" 100% trong HTML tÄ©nh,
 *  nhÆ°ng mÃ¬nh lÃ m logic giá»‘ng noitu.pro vÃ  cÃ³ danh sÃ¡ch khÃ¡ lá»›n.
 * Báº¡n cÃ³ thá»ƒ tá»± má»Ÿ rá»™ng thÃªm.)
 */
const VOCAB = [
  "Ä‘á»“ Äƒn","Äƒn váº·t","Äƒn sÃ¡ng","Äƒn trÆ°a","Äƒn tá»‘i","Äƒn chÆ¡i","Äƒn há»i","Äƒn cÆ°á»›i","Äƒn ngá»§",
  "bÃ¡nh mÃ¬","mÃ¬ gÃ³i","gÃ  rÃ¡n","cÆ¡m táº¥m","cÆ¡m rang","phá»Ÿ bÃ²","bÃºn bÃ²","bÃºn cháº£","trÃ  sá»¯a","sá»¯a chua",
  "cÃ  phÃª","phim áº£nh","áº£nh selfie","yÃªu thÆ°Æ¡ng","thÆ°Æ¡ng nhá»›","nhá»› nhÃ ","nhÃ  báº¿p","báº¿p ga","ga tÃ u",
  "tÃ u Ä‘iá»‡n","Ä‘i há»c","há»c bÃ i","bÃ i táº­p","táº­p gym","gym bro","bro code","code gml","gml maker",
  "maker game","game thá»§","thá»§ mÃ´n","mÃ´n toÃ¡n","toÃ¡n há»c","há»c sinh","sinh nháº­t","nháº­t kÃ½","kÃ½ á»©c",
  "á»©c gÃ ","gÃ  luá»™c","luá»™c trá»©ng","trá»©ng rÃ¡n","rÃ¡n cÃ¡","cÃ¡ kho","khoai tÃ¢y","tÃ¢y ban nha","nha khoa",
  "khoa há»c","há»c há»i","há»i bÃ i","bÃ i hÃ¡t","hÃ¡t hay","hay ho","hoÃ ng hÃ´n","hÃ´n lá»…","lá»… há»™i",
  "há»™i nhÃ³m","nhÃ³m chat","chat gpt","gpt bot","bot ai","ai thÃ´ng minh","minh hoáº¡","hoáº¡ sÄ©","sÄ© tá»­",
  "tá»­ táº¿","táº¿ nhá»‹","nhá»‹p tim","tim Ä‘áº­p","Ä‘áº­p há»™p","há»™p quÃ ","quÃ  táº·ng","táº·ng hoa","hoa há»“ng",
  "há»“ng hÃ o","hÃ o quang","quang há»£p","há»£p tÃ¡c","tÃ¡c pháº©m","pháº©m cháº¥t","cháº¥t lÆ°á»£ng","lÆ°á»£ng giÃ¡c",
  "giÃ¡c quan","quan há»‡","há»‡ máº·t trá»i","trá»i mÆ°a","mÆ°a rÃ o","rÃ o cáº£n","cáº£n trá»Ÿ","trá»Ÿ vá»","vá» nhÃ ",
  "nhÃ  trÆ°á»ng","trÆ°á»ng lá»›p","lá»›p trÆ°á»Ÿng","trÆ°á»Ÿng nhÃ³m","nhÃ³m 7a4","a4 genius","genius hub"
];

// chuáº©n hoÃ¡ vocab
const VOCAB_N = VOCAB.map(normalizeWord);

function openWordMode(mode){
  if(!currentTeam){ toast("Chá»n tá»• trÆ°á»›c Ä‘Ã£!"); return; }

  wordMode = mode;
  document.getElementById("word-ui").style.display = "block";
  document.getElementById("online-ui").style.display = (mode==="online") ? "block" : "none";
  document.getElementById("word-mode-tag").textContent = (mode==="ai")
    ? "ğŸ¤– Cháº¿ Ä‘á»™: Solo vá»›i Robot AI"
    : "ğŸŒ Cháº¿ Ä‘á»™: Online 1vs1 (P2P)";

  document.getElementById("word-rule-tag").textContent = "Luáº­t: chá»¯ cuá»‘i â†’ chá»¯ Ä‘áº§u";
  wordRestart();
}

function closeWord(){
  document.getElementById("word-ui").style.display = "none";
}

function wordRestart(){
  wordUsed = new Set();
  wordPoints = 0;
  wordLog = [];
  wordLast = "";

  // má»Ÿ mÃ n báº±ng 1 tá»« random
  const starter = VOCAB_N[Math.floor(Math.random()*VOCAB_N.length)];
  wordLast = starter;
  wordUsed.add(wordLast);
  logAdd("Há»‡ thá»‘ng", `Tá»« báº¯t Ä‘áº§u: "${wordLast}"`);

  updateWordUI();
  document.getElementById("word-input").value = "";
  document.getElementById("word-input").focus();

  if(wordMode==="ai"){
    // cho ngÆ°á»i chÆ¡i Ä‘i trÆ°á»›c
    logAdd("Robot AI", "Báº¡n Ä‘i trÆ°á»›c nhÃ© ğŸ‘€");
  }else{
    logAdd("Online", "Táº¡o phÃ²ng hoáº·c vÃ o phÃ²ng Ä‘á»ƒ báº¯t Ä‘áº§u.");
  }
}

function updateWordUI(){
  document.getElementById("word-last").textContent = wordLast
    ? `Tá»« hiá»‡n táº¡i: "${wordLast}" (káº¿t thÃºc: ${getLastChar(wordLast).toUpperCase()})`
    : "Tá»« hiá»‡n táº¡i: (chÆ°a cÃ³)";
  document.getElementById("word-score").textContent = `+${wordPoints} Ä‘iá»ƒm`;

  const logDiv = document.getElementById("word-log");
  logDiv.textContent = wordLog.join("\n");
  logDiv.scrollTop = logDiv.scrollHeight;
}

function logAdd(who, msg){
  const t = new Date();
  const hh = String(t.getHours()).padStart(2,'0');
  const mm = String(t.getMinutes()).padStart(2,'0');
  wordLog.push(`[${hh}:${mm}] ${who}: ${msg}`);
  updateWordUI();
}

/**
 * KIá»‚M TRA Tá»ª Há»¢P Lá»†
 * - khÃ´ng rá»—ng
 * - khÃ´ng trÃ¹ng
 * - pháº£i ná»‘i Ä‘Ãºng chá»¯
 * - pháº£i náº±m trong VOCAB (Ä‘Ã³ng vai trÃ² "tá»« Ä‘iá»ƒn")
 */
function validateWord(word, expectedFirst){
  const w = normalizeWord(word);

  if(!w) return { ok:false, reason:"Báº¡n chÆ°a nháº­p tá»«." };
  if(w.length < 2) return { ok:false, reason:"Tá»« quÃ¡ ngáº¯n." };
  if(wordUsed.has(w)) return { ok:false, reason:"Tá»« nÃ y Ä‘Ã£ dÃ¹ng rá»“i." };

  if(expectedFirst){
    const first = getFirstChar(w);
    if(first !== expectedFirst){
      return { ok:false, reason:`Sai luáº­t ná»‘i! Pháº£i báº¯t Ä‘áº§u báº±ng chá»¯ "${expectedFirst}".` };
    }
  }

  // kiá»ƒm tra "tá»« Ä‘iá»ƒn"
  if(!VOCAB_N.includes(w)){
    return { ok:false, reason:"Tá»« nÃ y khÃ´ng cÃ³ trong tá»« Ä‘iá»ƒn cá»§a há»‡ thá»‘ng." };
  }

  return { ok:true, word:w };
}

function submitWord(){
  if(!wordMode){ toast("ChÆ°a má»Ÿ cháº¿ Ä‘á»™ ná»‘i tá»«!"); return; }
  const input = document.getElementById("word-input");
  const raw = input.value;

  const expected = wordLast ? getLastChar(wordLast) : "";
  const check = validateWord(raw, expected);

  if(!check.ok){
    toast("âŒ " + check.reason);
    logAdd("Há»‡ thá»‘ng", "âŒ " + check.reason);
    return;
  }

  const w = check.word;
  wordUsed.add(w);
  wordLast = w;
  input.value = "";
  input.focus();

  wordPoints += 3; // Ä‘Ãºng +3 Ä‘iá»ƒm
  logAdd("Báº¡n", `âœ… "${w}" (+3 Ä‘iá»ƒm)`);

  updateWordUI();

  // cá»™ng Ä‘iá»ƒm cho tá»•
  addScore(currentTeam, 3);

  // bot pháº£n há»“i
  if(wordMode==="ai"){
    setTimeout(botTurn, BOT_DELAY);
  }else{
    // online: gá»­i cho peer
    onlineSendMove(w);
  }
}

/* =========================
   BOT AI (OFFLINE)
   - chá»n tá»« ná»‘i Ä‘Ãºng
   - Æ°u tiÃªn tá»« chÆ°a dÃ¹ng
   - cÃ³ kiá»ƒm tra há»£p lá»‡
========================= */
function botFindCandidates(lastWord){
  const need = getLastChar(lastWord);
  return VOCAB_N.filter(w => getFirstChar(w) === need && !wordUsed.has(w));
}

function botTurn(){
  const candidates = botFindCandidates(wordLast);

  if(candidates.length === 0){
    logAdd("Robot AI", "ğŸ˜µ TÃ´i háº¿t tá»« rá»“i... Báº¡n tháº¯ng!");
    toast("ğŸ† Báº¡n tháº¯ng Robot!");
    // thÆ°á»Ÿng thÃªm
    addScore(currentTeam, 10);
    logAdd("Há»‡ thá»‘ng", "ğŸ† ThÆ°á»Ÿng +10 Ä‘iá»ƒm cho tá»• vÃ¬ tháº¯ng Robot!");
    return;
  }

  // "AI": chá»n tá»« tá»‘i Æ°u hÆ¡n (chá»n tá»« cÃ³ nhiá»u Ä‘Æ°á»ng Ä‘i tiáº¿p theo)
  let best = candidates[0];
  let bestScore = -1;

  for(const w of candidates){
    const nextNeed = getLastChar(w);
    const nextCount = VOCAB_N.filter(x => getFirstChar(x)===nextNeed && !wordUsed.has(x)).length;
    const score = nextCount * 2 + Math.random(); // thÃªm random Ä‘á»ƒ bot khÃ´ng bá»‹ 1 mÃ u
    if(score > bestScore){
      bestScore = score;
      best = w;
    }
  }

  wordUsed.add(best);
  wordLast = best;
  logAdd("Robot AI", `ğŸ¤– "${best}"`);

  updateWordUI();
}

/* hint / give up */
function wordHint(){
  if(!wordLast){ toast("ChÆ°a cÃ³ tá»« Ä‘á»ƒ gá»£i Ã½."); return; }
  const cand = botFindCandidates(wordLast);
  if(cand.length===0){
    toast("KhÃ´ng cÃ³ gá»£i Ã½... báº¡n sáº¯p tháº¯ng ğŸ¤­");
    logAdd("Há»‡ thá»‘ng", "KhÃ´ng cÃ³ tá»« ná»‘i há»£p lá»‡ (theo tá»« Ä‘iá»ƒn).");
    return;
  }
  const sample = cand[Math.floor(Math.random()*cand.length)];
  toast("ğŸ’¡ Gá»£i Ã½: " + sample);
  logAdd("Há»‡ thá»‘ng", `ğŸ’¡ Gá»£i Ã½: "${sample}"`);
}

function wordGiveUp(){
  toast("ğŸ³ï¸ Báº¡n Ä‘Ã£ xin thua!");
  logAdd("Há»‡ thá»‘ng", "ğŸ³ï¸ Báº¡n xin thua.");
  if(wordMode==="ai"){
    logAdd("Robot AI", "ğŸ˜ Dá»… quÃ¡!");
  }
}

/* =========================
   ONLINE P2P (WebRTC)
   - táº¡o phÃ²ng / vÃ o phÃ²ng báº±ng link
   - trao Ä‘á»•i move Ä‘Æ¡n giáº£n
========================= */
let pc=null, dc=null;
let isHost=false;

const RTC_CFG = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function getRoomFromHash(){
  const h = location.hash.replace("#","");
  if(!h) return null;
  try{ return JSON.parse(atob(h)); }catch(e){ return null; }
}
function setRoomToHash(obj){
  location.hash = btoa(JSON.stringify(obj));
}

function onlineCreateRoom(){
  if(wordMode!=="online"){ return; }
  isHost = true;

  pc = new RTCPeerConnection(RTC_CFG);
  dc = pc.createDataChannel("noitu");

  dc.onopen = ()=> logAdd("Online", "âœ… Káº¿t ná»‘i thÃ nh cÃ´ng! Báº¯t Ä‘áº§u chÆ¡i.");
  dc.onmessage = (e)=> onlineOnMessage(e.data);

  pc.onicecandidate = ()=>{
    if(pc.localDescription){
      setRoomToHash({ type:"offer", sdp: pc.localDescription.sdp });
      document.getElementById("online-room").value = location.href;
    }
  };

  pc.createOffer().then(offer=>pc.setLocalDescription(offer));
  logAdd("Online", "ğŸ“Œ Äang táº¡o phÃ²ng... gá»­i link cho báº¡n khÃ¡c.");
}

function onlineJoinRoom(){
  if(wordMode!=="online"){ return; }

  const url = prompt("DÃ¡n link phÃ²ng (hoáº·c chá»‰ cáº§n dÃ¡n pháº§n sau dáº¥u #):");
  if(!url) return;

  // láº¥y hash
  let hash = "";
  if(url.includes("#")) hash = url.split("#")[1];
  else hash = url;

  let room=null;
  try{ room = JSON.parse(atob(hash)); }catch(e){
    toast("Link phÃ²ng khÃ´ng há»£p lá»‡!");
    return;
  }
  if(!room || room.type!=="offer"){ toast("Link phÃ²ng khÃ´ng Ä‘Ãºng!"); return; }

  isHost = false;

  pc = new RTCPeerConnection(RTC_CFG);
  pc.ondatachannel = (ev)=>{
    dc = ev.channel;
    dc.onopen = ()=> logAdd("Online", "âœ… Káº¿t ná»‘i thÃ nh cÃ´ng! Báº¯t Ä‘áº§u chÆ¡i.");
    dc.onmessage = (e)=> onlineOnMessage(e.data);
  };

  pc.onicecandidate = ()=>{
    if(pc.localDescription){
      // táº¡o answer link cho host
      const answerLink = btoa(JSON.stringify({ type:"answer", sdp: pc.localDescription.sdp }));
      document.getElementById("online-room").value =
        location.origin + location.pathname + "#" + answerLink;
      logAdd("Online", "ğŸ“Œ Gá»­i link ANSWER láº¡i cho chá»§ phÃ²ng!");
    }
  };

  pc.setRemoteDescription({ type:"offer", sdp: room.sdp })
    .then(()=>pc.createAnswer())
    .then(ans=>pc.setLocalDescription(ans));

  logAdd("Online", "â³ Äang vÃ o phÃ²ng...");
}

function onlineOnMessage(data){
  try{
    const msg = JSON.parse(data);
    if(msg.type==="move"){
      const w = msg.word;
      // Ã¡p dá»¥ng move cá»§a Ä‘á»‘i thá»§
      wordUsed.add(w);
      wordLast = w;
      logAdd("Äá»‘i thá»§", `ğŸ”¥ "${w}"`);
      toast("Äá»‘i thá»§ vá»«a ná»‘i: " + w);
    }
  }catch(e){
    // ignore
  }
}

function onlineSendMove(word){
  if(wordMode!=="online") return;
  if(dc && dc.readyState==="open"){
    dc.send(JSON.stringify({ type:"move", word }));
  }
}

/* =========================
   AUTO LOAD TEAM IF SAVED
========================= */
window.addEventListener("load", ()=>{
  weeklyResetIfNeeded();
  renderRanking();

  const saved = localStorage.getItem("team");
  if(saved){
    initTeam(saved);
  }
});

// enter submit
document.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    const wui = document.getElementById("word-ui");
    const mui = document.getElementById("math-game-ui");
    if(wui && wui.style.display !== "none"){
      submitWord();
    }else if(mui && mui.style.display !== "none"){
      submitMath();
    }
  }
});
</script>

</body>
</html>
